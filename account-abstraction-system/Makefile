# USDTgVerse Account Abstraction System Makefile
# Created by USDTgVerse Development Team
# Copyright © 2024 USDTgVerse. All rights reserved.

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -g
INCLUDES = -I./include
LIBS = -lpthread -lssl -lcrypto

# Directories
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
TEST_DIR = tests

# Source files
SOURCES = $(SRC_DIR)/account_abstraction.c
OBJECTS = $(SOURCES:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.o)

# Target
TARGET = $(BUILD_DIR)/libaccount_abstraction.a
SHARED_TARGET = $(BUILD_DIR)/libaccount_abstraction.so

# Test files
TEST_SOURCES = $(TEST_DIR)/test_account_abstraction.c
TEST_OBJECTS = $(TEST_SOURCES:$(TEST_DIR)/%.c=$(BUILD_DIR)/%.o)
TEST_TARGET = $(BUILD_DIR)/test_account_abstraction

# Default target
all: $(TARGET) $(SHARED_TARGET)

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Static library
$(TARGET): $(BUILD_DIR) $(OBJECTS)
	ar rcs $@ $(OBJECTS)
	@echo "✅ Static library built: $@"

# Shared library
$(SHARED_TARGET): $(BUILD_DIR) $(OBJECTS)
	$(CC) -shared -o $@ $(OBJECTS) $(LIBS)
	@echo "✅ Shared library built: $@"

# Object files
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Test target
test: $(TEST_TARGET)
	@echo "🧪 Running Account Abstraction System tests..."
	./$(TEST_TARGET)

# Test executable
$(TEST_TARGET): $(BUILD_DIR) $(TEST_OBJECTS) $(TARGET)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $(TEST_OBJECTS) -L$(BUILD_DIR) -laccount_abstraction $(LIBS)
	@echo "✅ Test executable built: $@"

# Test object files
$(BUILD_DIR)/%.o: $(TEST_DIR)/%.c
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Clean
clean:
	rm -rf $(BUILD_DIR)
	@echo "🧹 Cleaned build directory"

# Install
install: $(TARGET) $(SHARED_TARGET)
	@echo "📦 Installing Account Abstraction System..."
	sudo cp $(TARGET) /usr/local/lib/
	sudo cp $(SHARED_TARGET) /usr/local/lib/
	sudo cp $(INCLUDE_DIR)/account_abstraction.h /usr/local/include/
	sudo ldconfig
	@echo "✅ Account Abstraction System installed"

# Uninstall
uninstall:
	@echo "🗑️ Uninstalling Account Abstraction System..."
	sudo rm -f /usr/local/lib/libaccount_abstraction.a
	sudo rm -f /usr/local/lib/libaccount_abstraction.so
	sudo rm -f /usr/local/include/account_abstraction.h
	sudo ldconfig
	@echo "✅ Account Abstraction System uninstalled"

# Debug build
debug: CFLAGS += -DDEBUG -g3
debug: $(TARGET) $(SHARED_TARGET)

# Release build
release: CFLAGS += -DNDEBUG -O3
release: $(TARGET) $(SHARED_TARGET)

# Documentation
docs:
	@echo "📚 Generating documentation..."
	doxygen Doxyfile
	@echo "✅ Documentation generated in docs/"

# Format code
format:
	@echo "🎨 Formatting code..."
	clang-format -i $(SRC_DIR)/*.c $(INCLUDE_DIR)/*.h
	@echo "✅ Code formatted"

# Lint code
lint:
	@echo "🔍 Linting code..."
	cppcheck --enable=all --std=c99 $(SRC_DIR)/*.c $(INCLUDE_DIR)/*.h
	@echo "✅ Code linted"

# Memory check
memcheck: $(TEST_TARGET)
	@echo "🔍 Running memory check..."
	valgrind --leak-check=full --show-leak-kinds=all ./$(TEST_TARGET)
	@echo "✅ Memory check completed"

# Performance test
perf: $(TEST_TARGET)
	@echo "⚡ Running performance test..."
	perf stat ./$(TEST_TARGET)
	@echo "✅ Performance test completed"

# Coverage report
coverage: CFLAGS += --coverage
coverage: $(TEST_TARGET)
	@echo "📊 Running coverage test..."
	./$(TEST_TARGET)
	gcov $(SOURCES)
	@echo "✅ Coverage report generated"

# Help
help:
	@echo "USDTgVerse Account Abstraction System Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  all        - Build static and shared libraries (default)"
	@echo "  test       - Build and run tests"
	@echo "  clean      - Clean build directory"
	@echo "  install    - Install libraries and headers"
	@echo "  uninstall  - Uninstall libraries and headers"
	@echo "  debug      - Build with debug symbols"
	@echo "  release    - Build optimized release version"
	@echo "  docs       - Generate documentation"
	@echo "  format     - Format source code"
	@echo "  lint       - Lint source code"
	@echo "  memcheck   - Run memory leak check"
	@echo "  perf       - Run performance test"
	@echo "  coverage   - Generate coverage report"
	@echo "  help       - Show this help message"
	@echo ""
	@echo "Build configuration:"
	@echo "  CC         = $(CC)"
	@echo "  CFLAGS     = $(CFLAGS)"
	@echo "  INCLUDES   = $(INCLUDES)"
	@echo "  LIBS       = $(LIBS)"

.PHONY: all test clean install uninstall debug release docs format lint memcheck perf coverage help
